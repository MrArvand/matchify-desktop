name: Release Windows Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'  # Matches your local Flutter version exactly
          channel: 'stable'

      - name: Sync pubspec version with tag
        shell: pwsh
        run: |
          $ref = "${{ github.ref_name }}"
          $clean = $ref -replace '^v',''
          Write-Host "Setting pubspec.yaml version to $clean+1"
          $path = "pubspec.yaml"
          $content = Get-Content $path -Raw
          $newContent = $content -replace "(?m)^version:\s*.*$", "version: $clean+1"
          Set-Content -Path $path -Value $newContent -Encoding UTF8
          Write-Host "pubspec.yaml version updated"
          Write-Host "Current version line:" (Select-String -Path $path -Pattern "^version:")
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Windows executable
        run: |
          echo "Starting Flutter Windows build..."
          flutter build windows --release
          echo "Flutter build completed"
          
          # Check if build was successful
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "âœ… Build successful - Release directory exists"
            echo "Build contents:"
            Get-ChildItem "build\windows\x64\runner\Release" | Select-Object Name, Length
          } else {
            echo "âŒ Build failed - Release directory not found"
            echo "Available build directories:"
            if (Test-Path "build") {
              Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
            } else {
              echo "No build directory found at all"
            }
            exit 1
          }
        
      - name: List build directory contents
        run: |
          echo "Checking build directory structure..."
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Release directory exists"
            Get-ChildItem "build\windows\x64\runner\Release" -Recurse | Select-Object Name, Length, FullName
          } else {
            echo "Release directory does not exist"
            echo "Available directories:"
            Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
          }
        
      - name: Derive version
        id: version
        shell: pwsh
        run: |
          $ref = "${{ github.ref_name }}"
          $clean = $ref -replace '^v',''
          echo "clean=$clean" >> $env:GITHUB_OUTPUT
          echo "ref=$ref"   >> $env:GITHUB_OUTPUT

      - name: Compile Inno Setup Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.6
        with:
          path: setup.iss
          options: /DAppVersion=${{ steps.version.outputs.clean }}

      - name: Verify Inno Setup output
        run: |
          echo "Checking Inno Setup compilation output..."
          
          # Look for the generated installer
          $installerName = "matchify-desktop-setup-${{ github.ref_name }}.exe"
          $installerPath = "output\$installerName"
          
          if (Test-Path $installerPath) {
            $installerSize = (Get-Item $installerPath).Length
            echo "âœ… Installer created successfully: $installerName"
            echo "ğŸ“ Installer size: $([math]::Round($installerSize / 1MB, 2)) MB"
            echo "ğŸ“ Installer path: $installerPath"
          } else {
            echo "âŒ Installer not found at expected path: $installerPath"
            echo "ğŸ“‚ Checking output directory contents:"
            if (Test-Path "output") {
              Get-ChildItem "output" | Select-Object Name, Length, LastWriteTime
            } else {
              echo "Output directory does not exist"
            }
            exit 1
          }
      
      - name: Verify Inno Setup output
        run: |
          echo "Checking Inno Setup compilation output..."
          
          # Look for the generated installer
          $installerName = "matchify-desktop-setup-${{ github.ref_name }}.exe"
          $installerPath = "output\$installerName"
          
          if (Test-Path $installerPath) {
            $installerSize = (Get-Item $installerPath).Length
            echo "âœ… Installer created successfully: $installerName"
            echo "ğŸ“ Installer size: $([math]::Round($installerSize / 1MB, 2)) MB"
            echo "ğŸ“ Installer path: $installerPath"
          } else {
            echo "âŒ Installer not found at expected path: $installerPath"
            echo "ğŸ“‚ Checking output directory contents:"
            if (Test-Path "output") {
              Get-ChildItem "output" | Select-Object Name, Length, LastWriteTime
            } else {
              echo "Output directory does not exist"
            }
            
            # Try to find any installer that might have been created
            echo "ğŸ” Searching for any installer files..."
            $allFiles = Get-ChildItem -Recurse | Where-Object { $_.Name -like "*.exe" }
            if ($allFiles) {
              echo "Found executable files:"
              $allFiles | Select-Object Name, Length, FullName
            } else {
              echo "No executable files found"
            }
            
            exit 1
          }
          
          # List all files in output directory
          echo "ğŸ“‚ All files in output directory:"
          if (Test-Path "output") {
            Get-ChildItem "output" -Recurse | Select-Object Name, Length, FullName
          }
        
      - name: Create release archive (optional backup)
        run: |
          $version = "${{ github.ref_name }}"
          $version = $version -replace "v", ""
          
          # Create a backup ZIP for users who prefer it
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Creating backup ZIP archive for version: $version"
            $zipName = "matchify-desktop-windows-$version-backup.zip"
            Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath $zipName -Force
            echo "Backup ZIP created: $zipName"
            
            if (Test-Path $zipName) {
              $zipSize = (Get-Item $zipName).Length
              echo "Backup ZIP size: $([math]::Round($zipSize / 1MB, 2)) MB"
            }
          }
          
      - name: Verify final release files
        run: |
          $version = "${{ github.ref_name }}"
          $version = $version -replace "v", ""
          
          echo "Verifying final release files for version: $version"
          
          # Check installer
          $installerName = "matchify-desktop-setup-$version.exe"
          $installerPath = "output\$installerName"
          
          if (Test-Path $installerPath) {
            $installerSize = (Get-Item $installerPath).Length
            echo "âœ… Main installer: $installerName"
            echo "ğŸ“ Size: $([math]::Round($installerSize / 1MB, 2)) MB"
          } else {
            echo "âŒ Main installer not found: $installerPath"
          }
          
          # Check backup ZIP
          $zipName = "matchify-desktop-windows-$version-backup.zip"
          if (Test-Path $zipName) {
            $zipSize = (Get-Item $zipName).Length
            echo "âœ… Backup ZIP: $zipName"
            echo "ğŸ“ Size: $([math]::Round($zipSize / 1MB, 2)) MB"
          }
          
          # List all available files
          echo "ğŸ“‚ All available release files:"
          Get-ChildItem | Where-Object { $_.Name -like "*$version*" } | Select-Object Name, Length, LastWriteTime
          if (Test-Path "output") {
            echo "ğŸ“‚ Files in output directory:"
            Get-ChildItem "output" | Select-Object Name, Length, LastWriteTime
          }
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            output/matchify-desktop-setup-${{ github.ref_name }}.exe
            matchify-desktop-windows-${{ github.ref_name }}-backup.zip
          body: |
            ## Ù†Ø³Ø®Ù‡ ${{ github.ref_name }}
            
            ### ØªØºÛŒÛŒØ±Ø§Øª:
            - Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ… ØªØ·Ø¨ÛŒÙ‚
            - Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
            - Ø¨Ù‡Ø¨ÙˆØ¯ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
            - Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
            - **Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Inno Setup** ğŸ‰
            
            ### Ø¯Ø§Ù†Ù„ÙˆØ¯:
            **Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø§ØµÙ„ÛŒ (ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡):**
            ÙØ§ÛŒÙ„ `matchify-desktop-setup-${{ github.ref_name }}.exe` - Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø²ÛŒØ¨Ø§
            
            **Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†:**
            ÙØ§ÛŒÙ„ `matchify-desktop-windows-${{ github.ref_name }}-backup.zip` - Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ÛŒ Ú©Ù‡ ØªØ±Ø¬ÛŒØ­ Ù…ÛŒâ€ŒØ¯Ù‡Ù†Ø¯ Ø§Ø² ZIP Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù†Ø¯
            
            ### Ù†ØµØ¨:
            **Ø¨Ø§ Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Inno Setup (ØªÙˆØµÛŒÙ‡ Ø´Ø¯Ù‡):**
            1. ÙØ§ÛŒÙ„ `matchify-desktop-setup-${{ github.ref_name }}.exe` Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
            2. ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ø±Ø§Ø­Ù„ Ù†ØµØ¨ Ø±Ø§ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒØ¯
            3. Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ÛŒØ§Ù†Ø¨Ø±Ù‡Ø§ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            
            **Ø¨Ø§ ÙØ§ÛŒÙ„ ZIP:**
            1. ÙØ§ÛŒÙ„ ZIP Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
            2. Ù…Ø­ØªÙˆÛŒØ§Øª Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡â€ŒØ§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†ÛŒØ¯
            3. ÙØ§ÛŒÙ„ `matchify_desktop.exe` Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
            
            ### Ù…Ø²Ø§ÛŒØ§ÛŒ Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡ Inno Setup:
            âœ… Ù†ØµØ¨ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø§ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø²ÛŒØ¨Ø§
            âœ… Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒØ§Ù†Ø¨Ø± Ø¯Ø± Ù…Ù†ÙˆÛŒ Start Ùˆ Desktop
            âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Uninstaller
            âœ… Ù†ØµØ¨ Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ¹Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±
            âœ… Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ù‡ØªØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
            âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ
            
            ### Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±:
            Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯.
          draft: false
          prerelease: false
