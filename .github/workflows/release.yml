name: Release Windows Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'  # Matches your local Flutter version exactly
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Windows executable
        run: |
          echo "Starting Flutter Windows build..."
          flutter build windows --release
          echo "Flutter build completed"
          
          # Check if build was successful
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "✅ Build successful - Release directory exists"
            echo "Build contents:"
            Get-ChildItem "build\windows\x64\runner\Release" | Select-Object Name, Length
          } else {
            echo "❌ Build failed - Release directory not found"
            echo "Available build directories:"
            if (Test-Path "build") {
              Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
            } else {
              echo "No build directory found at all"
            }
            exit 1
          }
        
      - name: List build directory contents
        run: |
          echo "Checking build directory structure..."
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Release directory exists"
            Get-ChildItem "build\windows\x64\runner\Release" -Recurse | Select-Object Name, Length, FullName
          } else {
            echo "Release directory does not exist"
            echo "Available directories:"
            Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
          }
        
      - name: Create release archive
        run: |
          $version = "${{ github.ref_name }}"
          $version = $version -replace "v", ""
          
          # Check if build directory exists
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Creating archive for version: $version"
            Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "matchify-desktop-windows-$version.zip" -Force
            echo "Archive created successfully"
            
            # List the created archive
            if (Test-Path "matchify-desktop-windows-$version.zip") {
              $archiveSize = (Get-Item "matchify-desktop-windows-$version.zip").Length
              echo "Archive size: $([math]::Round($archiveSize / 1MB, 2)) MB"
            }
          } else {
            echo "ERROR: Build directory not found!"
            echo "Build failed or path is incorrect"
            exit 1
          }
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            matchify-desktop-windows-${{ github.ref_name }}.zip
          body: |
            ## نسخه ${{ github.ref_name }}
            
            ### تغییرات:
            - بهبود عملکرد سیستم تطبیق
            - رفع مشکلات گزارش‌گیری
            - بهبود رابط کاربری
            - اضافه شدن سیستم به‌روزرسانی خودکار
            
            ### دانلود:
            فایل اجرایی ویندوز در فایل ZIP بالا قرار دارد.
            
            ### نصب:
            1. فایل ZIP را دانلود کنید
            2. محتویات را در پوشه‌ای مناسب استخراج کنید
            3. فایل `matchify_desktop.exe` را اجرا کنید
            
            ### به‌روزرسانی خودکار:
            این نسخه از سیستم به‌روزرسانی خودکار پشتیبانی می‌کند.
            کاربران می‌توانند به‌روزرسانی‌ها را مستقیماً از داخل برنامه دریافت کنند.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
