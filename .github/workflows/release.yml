name: Release Windows Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'  # Matches your local Flutter version exactly
          channel: 'stable'
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Windows executable
        run: |
          echo "Starting Flutter Windows build..."
          flutter build windows --release
          echo "Flutter build completed"
          
          # Check if build was successful
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "âœ… Build successful - Release directory exists"
            echo "Build contents:"
            Get-ChildItem "build\windows\x64\runner\Release" | Select-Object Name, Length
          } else {
            echo "âŒ Build failed - Release directory not found"
            echo "Available build directories:"
            if (Test-Path "build") {
              Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
            } else {
              echo "No build directory found at all"
            }
            exit 1
          }
        
      - name: List build directory contents
        run: |
          echo "Checking build directory structure..."
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Release directory exists"
            Get-ChildItem "build\windows\x64\runner\Release" -Recurse | Select-Object Name, Length, FullName
          } else {
            echo "Release directory does not exist"
            echo "Available directories:"
            Get-ChildItem "build" -Recurse -Directory | Select-Object FullName
          }
        
      - name: Create release archive
        run: |
          $version = "${{ github.ref_name }}"
          $version = $version -replace "v", ""
          
          # Check if build directory exists
          if (Test-Path "build\windows\x64\runner\Release") {
            echo "Creating archive for version: $version"
            $archiveName = "matchify-desktop-windows-$version.zip"
            Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath $archiveName -Force
            echo "Archive created successfully: $archiveName"
            
            # List the created archive
            if (Test-Path $archiveName) {
              $archiveSize = (Get-Item $archiveName).Length
              echo "Archive size: $([math]::Round($archiveSize / 1MB, 2)) MB"
              
              # List files in the archive to verify contents
              echo "Archive contents:"
              Expand-Archive -Path $archiveName -DestinationPath "temp_extract" -Force
              Get-ChildItem "temp_extract" -Recurse | Select-Object Name, Length
              Remove-Item "temp_extract" -Recurse -Force
            }
          } else {
            echo "ERROR: Build directory not found!"
            echo "Build failed or path is incorrect"
            exit 1
          }
          
      - name: Rename archive for release
        run: |
          $version = "${{ github.ref_name }}"
          $version = $version -replace "v", ""
          $oldName = "matchify-desktop-windows-$version.zip"
          $newName = "matchify-desktop-windows-${{ github.ref_name }}.zip"
          
          echo "Renaming archive for release compatibility..."
          echo "Old name: $oldName"
          echo "New name: $newName"
          
          if (Test-Path $oldName) {
            Rename-Item -Path $oldName -NewName $newName
            echo "âœ… Archive renamed successfully"
            
            # Verify the new file exists
            if (Test-Path $newName) {
              $archiveSize = (Get-Item $newName).Length
              echo "ğŸ“ New archive: $newName"
              echo "ğŸ“Š Size: $([math]::Round($archiveSize / 1MB, 2)) MB"
            }
          } else {
            echo "âŒ Original archive not found: $oldName"
            exit 1
          }
          
      - name: Verify archive file
        run: |
          $releaseFileName = "matchify-desktop-windows-${{ github.ref_name }}.zip"
          
          echo "Verifying archive file for release: $releaseFileName"
          if (Test-Path $releaseFileName) {
            $archiveSize = (Get-Item $releaseFileName).Length
            echo "âœ… Archive file exists: $releaseFileName"
            echo "ğŸ“ Archive size: $([math]::Round($archiveSize / 1MB, 2)) MB"
            
            # List current directory to see all files
            echo "ğŸ“‚ Files in current directory:"
            Get-ChildItem | Select-Object Name, Length, LastWriteTime
          } else {
            echo "âŒ Archive file not found: $releaseFileName"
            echo "ğŸ“‚ Files in current directory:"
            Get-ChildItem | Select-Object Name, Length, LastWriteTime
            exit 1
          }
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            matchify-desktop-windows-${{ github.ref_name }}.zip
          body: |
            ## Ù†Ø³Ø®Ù‡ ${{ github.ref_name }}
            
            ### ØªØºÛŒÛŒØ±Ø§Øª:
            - Ø¨Ù‡Ø¨ÙˆØ¯ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ… ØªØ·Ø¨ÛŒÙ‚
            - Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ
            - Ø¨Ù‡Ø¨ÙˆØ¯ Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
            - Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
            
            ### Ø¯Ø§Ù†Ù„ÙˆØ¯:
            ÙØ§ÛŒÙ„ Ø§Ø¬Ø±Ø§ÛŒÛŒ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¯Ø± ÙØ§ÛŒÙ„ ZIP Ø¨Ø§Ù„Ø§ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.
            
            ### Ù†ØµØ¨:
            1. ÙØ§ÛŒÙ„ ZIP Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
            2. Ù…Ø­ØªÙˆÛŒØ§Øª Ø±Ø§ Ø¯Ø± Ù¾ÙˆØ´Ù‡â€ŒØ§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†ÛŒØ¯
            3. ÙØ§ÛŒÙ„ `matchify_desktop.exe` Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯
            
            ### Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±:
            Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø² Ø³ÛŒØ³ØªÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
            Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² Ø¯Ø§Ø®Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯.
          draft: false
          prerelease: false
